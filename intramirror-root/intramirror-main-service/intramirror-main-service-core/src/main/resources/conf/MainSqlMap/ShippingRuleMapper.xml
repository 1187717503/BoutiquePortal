<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.intramirror.main.core.mapper.ShippingRuleMapper">
    <resultMap id="BaseResultMap" type="com.intramirror.main.api.model.ShippingRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="shipping_rule_id" property="shippingRuleId" jdbcType="BIGINT"/>
        <result column="category_id" property="categoryId" jdbcType="BIGINT"/>
        <result column="from_country_id" property="fromCountryId" jdbcType="BIGINT"/>
        <result column="to_country_id" property="toCountryId" jdbcType="BIGINT"/>
        <result column="shipping_provider_id" property="shippingProviderId" jdbcType="BIGINT"/>
        <result column="threshold" property="threshold" jdbcType="INTEGER"/>
        <result column="rate" property="rate" jdbcType="DECIMAL"/>
        <result column="min_number" property="minNumber" jdbcType="DECIMAL"/>
        <result column="max_number" property="maxNumber" jdbcType="DECIMAL"/>
        <result column="deduction" property="deduction" jdbcType="INTEGER"/>
        <result column="base_fee" property="baseFee" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        shipping_rule_id, category_id, from_country_id, to_country_id, shipping_provider_id,
        threshold, rate, min_number, max_number, deduction, base_fee
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from shipping_rule
        where shipping_rule_id = #{shippingRuleId,jdbcType=BIGINT}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from shipping_rule
        where shipping_rule_id = #{shippingRuleId,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.intramirror.main.api.model.ShippingRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into shipping_rule (shipping_rule_id, category_id, from_country_id,
        to_country_id, shipping_provider_id, threshold,
        rate, min_number, max_number,
        deduction, base_fee)
        values (#{shippingRuleId,jdbcType=BIGINT}, #{categoryId,jdbcType=BIGINT}, #{fromCountryId,jdbcType=BIGINT},
        #{toCountryId,jdbcType=BIGINT}, #{shippingProviderId,jdbcType=BIGINT}, #{threshold,jdbcType=INTEGER},
        #{rate,jdbcType=DECIMAL}, #{minNumber,jdbcType=DECIMAL}, #{maxNumber,jdbcType=DECIMAL},
        #{deduction,jdbcType=INTEGER}, #{baseFee,jdbcType=INTEGER})
    </insert>
    <insert id="insertSelective" parameterType="com.intramirror.main.api.model.ShippingRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into shipping_rule
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="shippingRuleId != null">
                shipping_rule_id,
            </if>
            <if test="categoryId != null">
                category_id,
            </if>
            <if test="fromCountryId != null">
                from_country_id,
            </if>
            <if test="toCountryId != null">
                to_country_id,
            </if>
            <if test="shippingProviderId != null">
                shipping_provider_id,
            </if>
            <if test="threshold != null">
                threshold,
            </if>
            <if test="rate != null">
                rate,
            </if>
            <if test="minNumber != null">
                min_number,
            </if>
            <if test="maxNumber != null">
                max_number,
            </if>
            <if test="deduction != null">
                deduction,
            </if>
            <if test="baseFee != null">
                base_fee,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="shippingRuleId != null">
                #{shippingRuleId,jdbcType=BIGINT},
            </if>
            <if test="categoryId != null">
                #{categoryId,jdbcType=BIGINT},
            </if>
            <if test="fromCountryId != null">
                #{fromCountryId,jdbcType=BIGINT},
            </if>
            <if test="toCountryId != null">
                #{toCountryId,jdbcType=BIGINT},
            </if>
            <if test="shippingProviderId != null">
                #{shippingProviderId,jdbcType=BIGINT},
            </if>
            <if test="threshold != null">
                #{threshold,jdbcType=INTEGER},
            </if>
            <if test="rate != null">
                #{rate,jdbcType=DECIMAL},
            </if>
            <if test="minNumber != null">
                #{minNumber,jdbcType=DECIMAL},
            </if>
            <if test="maxNumber != null">
                #{maxNumber,jdbcType=DECIMAL},
            </if>
            <if test="deduction != null">
                #{deduction,jdbcType=INTEGER},
            </if>
            <if test="baseFee != null">
                #{baseFee,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.intramirror.main.api.model.ShippingRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update shipping_rule
        <set>
            <if test="categoryId != null">
                category_id = #{categoryId,jdbcType=BIGINT},
            </if>
            <if test="fromCountryId != null">
                from_country_id = #{fromCountryId,jdbcType=BIGINT},
            </if>
            <if test="toCountryId != null">
                to_country_id = #{toCountryId,jdbcType=BIGINT},
            </if>
            <if test="shippingProviderId != null">
                shipping_provider_id = #{shippingProviderId,jdbcType=BIGINT},
            </if>
            <if test="threshold != null">
                threshold = #{threshold,jdbcType=INTEGER},
            </if>
            <if test="rate != null">
                rate = #{rate,jdbcType=DECIMAL},
            </if>
            <if test="minNumber != null">
                min_number = #{minNumber,jdbcType=DECIMAL},
            </if>
            <if test="maxNumber != null">
                max_number = #{maxNumber,jdbcType=DECIMAL},
            </if>
            <if test="deduction != null">
                deduction = #{deduction,jdbcType=INTEGER},
            </if>
            <if test="baseFee != null">
                base_fee = #{baseFee,jdbcType=INTEGER},
            </if>
        </set>
        where shipping_rule_id = #{shippingRuleId,jdbcType=BIGINT}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.intramirror.main.api.model.ShippingRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update shipping_rule
        set category_id = #{categoryId,jdbcType=BIGINT},
        from_country_id = #{fromCountryId,jdbcType=BIGINT},
        to_country_id = #{toCountryId,jdbcType=BIGINT},
        shipping_provider_id = #{shippingProviderId,jdbcType=BIGINT},
        threshold = #{threshold,jdbcType=INTEGER},
        rate = #{rate,jdbcType=DECIMAL},
        min_number = #{minNumber,jdbcType=DECIMAL},
        max_number = #{maxNumber,jdbcType=DECIMAL},
        deduction = #{deduction,jdbcType=INTEGER},
        base_fee = #{baseFee,jdbcType=INTEGER}
        where shipping_rule_id = #{shippingRuleId,jdbcType=BIGINT}
    </update>


    <select id="getShippingFeeByProductIds" resultType="java.util.HashMap">
        select a.product_id , a.address_country_id, FORMAT(
        case when a.sales_price*er.current_rate &gt;= sr.threshold and
        (sr.base_fee+(a.sales_price*er.current_rate-sr.deduction)*sr.rate) &lt;= sr.max_number then
        sr.base_fee+(a.sales_price*er.current_rate-sr.deduction)*sr.rate
        when (sr.base_fee+(a.sales_price*er.current_rate-sr.deduction)*sr.rate) &gt; sr.max_number then sr.max_number
        when a.sales_price*er.current_rate &lt; sr.threshold then sr.base_fee else NULL end,2) as fee , er.current_rate
        as
        current_rate, sr.min_number
        from (
        select p.category_id,v.address_country_id,p.product_id,max(sps.sale_price) as sales_price
        from shop_product_sku sps
        inner join shop_product s on s.shop_product_id = sps.shop_product_id and s.enabled = 1
        inner join product p on p.product_id = s.product_id and p.enabled = 1
        inner join vendor v on p.vendor_id = v.vendor_id
        where sps.enabled = 1
        and p.product_id in
        <foreach collection="productIds" item="productId" index="index"
                 open="(" close=")" separator=",">
            #{productId}
        </foreach>
        group by p.product_id
        ) a left join shipping_rule sr on a.category_id = sr.category_id and sr.from_country_id = a.address_country_id
        and sr.to_country_id = #{toCountry}
        inner join exchange_rate er where er.from_country = 'EUR' and er.to_country = 'CNY'
    </select>
</mapper>